package com.michaldrabik.ui_my_movies.mymovies.views

import android.content.Context
import android.util.AttributeSet
import android.view.LayoutInflater
import android.view.ViewGroup.LayoutParams.MATCH_PARENT
import android.view.ViewGroup.LayoutParams.WRAP_CONTENT
import android.widget.FrameLayout
import android.widget.GridLayout
import androidx.core.view.updatePadding
import com.michaldrabik.ui_base.common.ListViewMode
import com.michaldrabik.ui_base.common.ListViewMode.GRID
import com.michaldrabik.ui_base.common.ListViewMode.GRID_TITLE
import com.michaldrabik.ui_base.common.ListViewMode.LIST_COMPACT
import com.michaldrabik.ui_base.common.ListViewMode.LIST_NORMAL
import com.michaldrabik.ui_base.utilities.extensions.dimenToPx
import com.michaldrabik.ui_base.utilities.extensions.screenWidth
import com.michaldrabik.ui_my_movies.R
import com.michaldrabik.ui_my_movies.databinding.ViewMyMoviesRecentsBinding
import com.michaldrabik.ui_my_movies.mymovies.recycler.MyMoviesItem

class MyMoviesRecentsView : FrameLayout {

  constructor(context: Context) : super(context)
  constructor(context: Context, attrs: AttributeSet?) : super(context, attrs)
  constructor(context: Context, attrs: AttributeSet?, defStyleAttr: Int) : super(context, attrs, defStyleAttr)

  private val binding = ViewMyMoviesRecentsBinding.inflate(LayoutInflater.from(context), this)

  init {
    layoutParams = LayoutParams(MATCH_PARENT, WRAP_CONTENT)
    clipChildren = false
  }

  private val itemMargin by lazy { context.dimenToPx(R.dimen.spaceTiny) }
  private val itemHeight by lazy { context.dimenToPx(R.dimen.myMoviesFanartHeight) }
  private val itemWidth by lazy { (screenWidth() - context.dimenToPx(R.dimen.spaceNormal) - (4 * itemMargin)) / 2 }

  fun bind(
    item: MyMoviesItem.RecentsSection,
    viewMode: ListViewMode,
    itemClickListener: ((MyMoviesItem) -> Unit)?,
    itemLongClickListener: ((MyMoviesItem) -> Unit)?,
  ) {
    binding.myMoviesRecentsContainer.removeAllViews()

    val clickListener: (MyMoviesItem) -> Unit = { itemClickListener?.invoke(it) }
    val longClickListener: (MyMoviesItem) -> Unit = { itemLongClickListener?.invoke(it) }

    item.items.forEachIndexed { index, showItem ->
      val view = MyMovieFanartView(context).apply {
        layoutParams = LayoutParams(0, MATCH_PARENT)
        bind(showItem, clickListener, longClickListener)
      }
      val layoutParams = GridLayout.LayoutParams().apply {
        width = itemWidth
        height = itemHeight
        columnSpec = GridLayout.spec(index % 2, 1F)
        setMargins(itemMargin, itemMargin, itemMargin, itemMargin)
      }
      binding.myMoviesRecentsContainer.addView(view, layoutParams)
    }

    bindMargins(viewMode)
  }

  private fun bindMargins(viewMode: ListViewMode) {
    when (viewMode) {
      GRID, GRID_TITLE -> {
        binding.myMoviesRecentsContainer.updatePadding(
          left = resources.getDimensionPixelSize(R.dimen.myMoviesRecentsGridPadding),
          right = resources.getDimensionPixelSize(R.dimen.myMoviesRecentsGridPadding),
        )
      }
      LIST_NORMAL, LIST_COMPACT -> {
        binding.myMoviesRecentsContainer.updatePadding(
          left = resources.getDimensionPixelSize(R.dimen.spaceSmall),
          right = resources.getDimensionPixelSize(R.dimen.spaceSmall),
        )
      }
    }
  }
}
